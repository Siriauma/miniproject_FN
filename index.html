<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Data Management</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<style>

body {
    font-family: 'Rubik', sans-serif;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    position: relative;
    overflow: hidden;
}

/* ‡πÉ‡∏™‡πà‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ö‡∏ö‡∏à‡∏≤‡∏á‡∏•‡∏á */
body::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('01_blood-pressure.jpg'); /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏û */
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    opacity: 0.4; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏û (0.0 - 1.0) */
    z-index: -1; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏†‡∏≤‡∏û‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ */
}

/* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏°‡∏ô‡∏π */
.sidebar {
    position: fixed;
    left: -250px;
    top: 0;
    width: 250px;
    height: 100%;
    background: #00a86b;
    transition: left 0.3s ease-in-out;
    padding-top: 40px;
    color: white;
}

/* ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π */
.sidebar a {
    border: 1px solid rgb(232, 230, 230);
    display: block;
    padding: 15px;
    text-decoration: none;
    color: rgb(255, 255, 255);
    font-size: 18px;
    transition: 0.3s;
}

/* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π */
.sidebar a:hover {
    background: rgba(165, 30, 30, 0.2);
}

.sidebar.show {
    left: 0;
}

.dashboard-card {
    background-color: hsl(144, 63%, 70%);
    border: 1px solid #000000;
    border-radius: 5px;
    padding: 6px;
    margin: 5px;
    text-align: center;
    flex: 0;
    height: 100px;
}

.charts {
    margin-top: 50px;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 10px; /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≤‡∏Å "10 px" ‡πÄ‡∏õ‡πá‡∏ô "10px" */
}

.chart-container {
    flex: 1 1 250px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° */
    max-width: 500px; /* ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î */
    min-width: 100px;
    margin: 5px;
}

.chart-container canvas {
    width: 100% !important;
    height: 250px !important; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ */
    max-height: 200px;
    object-fit: contain; /* ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏•‡πâ‡∏ô */
}

/* Button to open sidebar */
.open-btn {
    position: fixed;
    left: 20px;
    top: 20px;
    background: #00a86b;
    color: white;
    border: none;
    padding: 10px 15px;
    cursor: pointer;
    border-radius: 5px;
}

/* ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Container */
.container {
    transition: margin-left 0.3s ease-in-out;
    margin-left: 0;
    padding: 20px;
}

.sidebar.show + .container {
    margin-left: 250px;
}

/* Card */
.card {
    background-color: #ffffff;
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    width: 420px;
    text-align: center;
    margin: 20px;
}

h1 {
    font-size: 32px;
    color: #022c90;
    margin-bottom: 20px;
    font-weight: 700;
}

.input-field,
.role-select {
    width: 100%;
    padding: 14px;
    margin: 12px 0;
    border: 2px solid #d3c6fc;
    border-radius: 12px;
    font-size: 15px;
    background-color: #f9f9ff;
}

.header-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    border-radius: 5px;
}

.hidden-fields {
    display: none;
    margin-top: 20px;
}

/* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ container ‡∏°‡∏µ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏¢‡∏≠‡∏∞ */
.container {
    max-height: 90vh; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 90% ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
    overflow-y: auto; /* ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
}

/* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡πÑ‡∏ï‡∏•‡πå scrollbar ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô */
.container::-webkit-scrollbar {
    width: 10px;
}

.container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 5px;
}

.container::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 5px;
}

.container::-webkit-scrollbar-thumb:hover {
    background: #555;
}

html,
body {
    overflow-y: auto;
}

/* Media Queries ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô */
@media (max-width: 768px) {
    .sidebar {
        width: 200px;
    }
    .card {
        width: 90%; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
    }
}

@media (max-width: 480px) {
    .sidebar {
        width: 150px;
    }
    .card {
        width: 95%; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
    }
    h1 {
        font-size: 24px; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
    }
    .input-field, .role-select {
        font-size: 14px; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÉ‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå */
    }
}

  </style>
</head>
<body>

   <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î Sidebar -->
  <button class="open-btn" onclick="toggleSidebar()">‚ò∞ ‡πÄ‡∏°‡∏ô‡∏π</button>

  <!-- Sidebar -->
  <div class="sidebar" id="mySidebar">
    <a href="home.html">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
    <a href="register.html">üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a>
    <a href="index.html">‚ù§Ô∏è ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</a>
    <a href="#" onclick="toggleSidebar()">‚ùå ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π</a>
  </div>
<body onload="get_health_data()">


        <div class="container mt-4">
            <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h2>
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="dashboard-card">
                        <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                        <p id="totalRecords">Loading...</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="dashboard-card">
                        <h4>‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡πâ‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à</h4>
                        <p id="avgHeartRate">Loading...</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="dashboard-card">
                        <h4>‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï</h4>
                        <p id="avgBloodPressure">Loading...</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="dashboard-card">
                        <h4>‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</h4>
                        <p id="avgTemperature">Loading...</p>
                    </div>
                </div>
            </div>

            <div class="charts">
            <div class="chart-container">
                <h2>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡πâ‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h2>
                <canvas id="healthChart" width="300" height="400"></canvas>
            </div>
            <div class="chart-container">
                <h2>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡πâ‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h2>
                <canvas id="averageHeartRateChart" width="100" height="400"></canvas>
            </div>


            <div class="header-container">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#healthDataModal" onclick="click_modal_add()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</button>
            </div>
           
            
            
            <table class="table table-bordered" id="table_health_data">
                <thead>
                    <tr>
                        <th>Num</th>
                        <th>‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏™‡∏∏‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</th>
                        <th>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à</th>
                        <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï</th>
                        <th>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</th>
                        <th>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                        <th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="tbl_health_data"></tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="healthDataModal" tabindex="-1" aria-labelledby="FormModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="FormModalLabel">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit_type">
                    <div class="mb-3">
                        <label for="form_elderly_id" class="form-label">elderly_id</label>
                        <select id="form_elderly_id" class="form-select">
                            <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏ --</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="form_heart_rate" class="form-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à</label>
                        <input type="text" id="form_heart_rate" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="form_blood_pressure" class="form-label">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï</label>
                        <input type="text" id="form_blood_pressure" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="form_temperature" class="form-label">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</label>
                        <input type="text" id="form_temperature" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                    <button type="button" class="btn btn-primary" onclick="save_health_data()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î Sidebar
        function toggleSidebar() {
            document.getElementById("mySidebar").classList.toggle("show");
        }
    
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏
        function toggleFields() {
            const role = document.getElementById('role').value;
            document.getElementById('elderly-fields').style.display = role === 'elderly' ? 'block' : 'none';
        }
        // Load the list of elderly people to the select input
        function loadElderlyList() {
            fetch("https://im-i62-231-mini-project-bn.vercel.app/api/elderlys/")
                .then(response => response.json())
                .then(data => {
                    let dropdown = document.getElementById("form_elderly_id");
                    dropdown.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏ --</option>';
                    data.forEach(elderly => {
                        let option = document.createElement("option");
                        option.value = elderly.id;
                        option.textContent = elderly.name;
                        dropdown.appendChild(option);
                    });
                })
                .catch(error => console.error("Error loading elderly data:", error));
        }

        // Open modal to add new health data
        function click_modal_add() {
            document.getElementById('FormModalLabel').innerHTML = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û";
            document.getElementById('edit_type').value = "create";

            document.getElementById('form_elderly_id').value = "";
            document.getElementById('form_heart_rate').value = "";
            document.getElementById('form_blood_pressure').value = "";
            document.getElementById('form_temperature').value = "";

            loadElderlyList();
        }

        // Save health data (either create or update)
        function save_health_data() {
            const healthData = {
                elderly_id: document.getElementById("form_elderly_id").value,
                heart_rate: document.getElementById("form_heart_rate").value,
                blood_pressure: document.getElementById("form_blood_pressure").value,
                temperature: document.getElementById("form_temperature").value
            };

            const editType = document.getElementById("edit_type").value;
            let url = "https://im-i62-231-mini-project-bn.vercel.app/api/health/";
            let method = "POST";

            if (editType === "update") {
                let elderly_id = document.getElementById("form_elderly_id").value;
                url += elderly_id;  
                method = "PUT";
            }

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(healthData)
            })
            .then(response => response.json())
            .then(data => {
                get_health_data();
                document.querySelector('[data-bs-dismiss="modal"]').click();
            })
            .catch(error => console.error('Error:', error));
        }

        // Fetch and display health data
        function get_health_data() {
            fetch('https://im-i62-231-mini-project-bn.vercel.app/api/healths/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const tableRef = document.querySelector("#table_health_data tbody");
                    tableRef.innerHTML = "";
        
                    let totalHeartRate = 0;
                    let totalBloodPressure = 0;
                    let totalTemperature = 0;
        
                    data.forEach((element, index) => {
                        let row = tableRef.insertRow();
                        row.innerHTML = `<td>${index + 1}</td>
                                        <td>${element.elderly_id}</td>
                                        <td>${element.heart_rate}</td>
                                        <td>${element.blood_pressure}</td>
                                        <td>${element.temperature}</td>
                                        <td>${moment.utc(element.recorded_at).format('DD/MM/YYYY HH:mm:ss')}</td>
                                        <td>
                                           <button class="btn btn-warning" onclick="edit_health_data('${element.elderly_id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                           <button class="btn btn-danger" onclick="delete_health_data('${element.id}')">‡∏•‡∏ö</button>
                                        </td>`;
                        totalHeartRate += parseFloat(element.heart_rate);
                        totalBloodPressure += parseFloat(element.blood_pressure.split('/')[0]); // ‡πÉ‡∏ä‡πâ Systolic ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                        totalTemperature += parseFloat(element.temperature);
                    });
        
                    // Update the average values in the dashboard
                    const averageHeartRate = (totalHeartRate / data.length).toFixed(2);
                    const averageBloodPressure = (totalBloodPressure / data.length).toFixed(2);
                    const averageTemperature = (totalTemperature / data.length).toFixed(2);
                    document.getElementById("avgHeartRate").innerText = averageHeartRate + " bpm";
                    document.getElementById("avgBloodPressure").innerText = averageBloodPressure + " mmHg";
                    document.getElementById("avgTemperature").innerText = averageTemperature + " ¬∞C";
                    document.getElementById("totalRecords").innerText = data.length;
        
                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
                    load_health_chart(); 
                    load_average_heart_rate_chart(data); // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
                })
                .catch(error => console.error("Error loading health data:", error));
        }
        // Edit health data
        function edit_health_data(elderly_id) {
            console.log("elderly_id ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏°‡∏≤:", elderly_id);
            document.getElementById('FormModalLabel').innerHTML = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û";
            document.getElementById('edit_type').value = "update";
        
            fetch(`https://im-i62-231-mini-project-bn.vercel.app/api/health/` + elderly_id)
                .then(response => response.json())
                .then(data => {
                    if (data.health_data && data.health_data.length > 0) {
                        let health = data.health_data[0]; // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å
                        console.log("Health ID ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å API:", health.id);
        
                        document.getElementById('form_elderly_id').value = health.elderly_id || "";
                        document.getElementById('form_heart_rate').value = health.heart_rate || "";
                        document.getElementById('form_blood_pressure').value = health.blood_pressure || "";
                        document.getElementById('form_temperature').value = health.temperature || "";
                        new bootstrap.Modal(document.getElementById('healthDataModal')).show();
                    } else {
                        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏");
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // Delete health data
        function delete_health_data(id) { // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å elderly_id ‡πÄ‡∏õ‡πá‡∏ô id
            if (confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                fetch(`https://im-i62-231-mini-project-bn.vercel.app/api/health/${id}`, { // ‡πÉ‡∏ä‡πâ id ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                    method: "DELETE",
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    get_health_data();  // Refresh the table
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + error.message);
                });
            }
    }
    let healthChart;
let averageHeartRateChart;

function load_health_chart() {
    fetch('https://im-i62-231-mini-project-bn.vercel.app/api/healths/')
        .then(response => response.json())
        .then(data => {
            let labels = [];
            let heartRates = [];
            let highRiskAlerts = [];
            let uniqueElderly = new Set();

            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô
            let sevenDaysAgo = moment().subtract(7, 'days');
            data = data.filter(item => moment.utc(item.recorded_at).isAfter(sevenDaysAgo));

            data.forEach(item => {
                if (!uniqueElderly.has(item.elderly_id)) {
                    labels.push(`‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏ ${item.elderly_id}`);
                    heartRates.push(item.heart_rate);
                    uniqueElderly.add(item.elderly_id);
                }

                if (item.blood_pressure > 140 || item.temperature > 38) {
                    highRiskAlerts.push(`‚ùó ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏™‡∏π‡∏á‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥! ‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏ ${item.elderly_id}`);
                }
            });

            if (highRiskAlerts.length > 0) {
                alert(highRiskAlerts.join("\n"));
            }

            const ctx = document.getElementById('healthChart').getContext('2d');

            if (healthChart) {
                healthChart.data.labels = labels;
                healthChart.data.datasets[0].data = heartRates;
                healthChart.update();
            } else {
                healthChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Heart Rate',
                            data: heartRates,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                suggestedMax: Math.max(...heartRates) + 20,
                                ticks: {
                                    color: '#000000',  // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏î‡∏≥
                                    font: {
                                        size: 14, // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô
                                        family: 'Arial, sans-serif' // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#000000',  // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏î‡∏≥
                                    font: {
                                        size: 14,
                                        family: 'Arial, sans-serif'
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#000000',  // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏≠‡∏á legend ‡πÄ‡∏õ‡πá‡∏ô‡∏î‡∏≥
                                    font: {
                                        size: 16,
                                        weight: 'bold',
                                        family: 'Arial, sans-serif'
                                    }
                                }
                            },
                            title: {
                                display: true,
                               
                            }
                        }
                    }
                });
            }

            load_average_heart_rate_chart(data); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        })
        .catch(error => {
            console.error("Error loading health chart data:", error);
        });
}


function load_average_heart_rate_chart(data) {
    const ctx = document.getElementById('averageHeartRateChart').getContext('2d');
    const heartRates = data.map(item => item.heart_rate);
    const labels = data.map(item => moment.utc(item.recorded_at).format('DD/MM/YYYY'));

    if (averageHeartRateChart) {
        averageHeartRateChart.data.labels = labels;
        averageHeartRateChart.data.datasets[0].data = heartRates;
        averageHeartRateChart.update();
    } else {
        averageHeartRateChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Average Heart Rate',
                    data: heartRates,
                    fill: false,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderWidth: 2,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        suggestedMax: Math.max(...heartRates) + 20,
                        ticks: {
                            color: '#000000',  // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏î‡∏≥
                            font: {
                                size: 14,  // ‚úÖ ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô
                                family: 'Arial, sans-serif'
                            }
                        }
                    },
                    x: {
                        ticks: {
                            color: '#000000',  // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏î‡∏≥
                            font: {
                                size: 14,  // ‚úÖ ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô
                                family: 'Arial, sans-serif'
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#000000',  // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏î‡∏≥
                            font: {
                                size: 16,  // ‚úÖ ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏≠‡∏á Legend ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô
                                weight: 'bold',
                                family: 'Arial, sans-serif'
                            }
                        }
                    },
                    title: {
                        display: true,
                    }
                }
            }
        });
    }
}


// üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ)
setInterval(load_health_chart, 10000);

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
load_health_chart();

</script>
</body>

</html>

